name: Push Single Docker Image to GHCR
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image from Docker Hub (e.g., ubuntu:22.04, nginx:latest, redis:7.0-alpine)'
        required: true
        type: string
env:
  REGISTRY: ghcr.io
jobs:
  push-image:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull and push image to GHCR
        shell: pwsh
        run: |
          $SOURCE_IMAGE = "${{ github.event.inputs.image }}"
          $OWNER = "${{ github.repository_owner }}".ToLower()
          
          # Extract image name and tag
          if ($SOURCE_IMAGE.Contains(':')) {
            $parts = $SOURCE_IMAGE -split ':'
            $IMAGE_NAME = $parts[0].ToLower()
            $TAG = $parts[1]
          } else {
            $IMAGE_NAME = $SOURCE_IMAGE.ToLower()
            $TAG = 'latest'
          }
          
          $TARGET_IMAGE = "${{ env.REGISTRY }}/$OWNER/$IMAGE_NAME"
          $TAGGED_IMAGE = "$TARGET_IMAGE`:$TAG"
          
          Write-Host "===================================="
          Write-Host "Source: $SOURCE_IMAGE"
          Write-Host "Target: $TAGGED_IMAGE"
          Write-Host "===================================="
          Write-Host ""
          
          try {
            Write-Host "Pulling image from Docker Hub..."
            docker pull "$SOURCE_IMAGE" --quiet
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to pull image"
            }
            
            Write-Host "Tagging image..."
            docker tag "$SOURCE_IMAGE" "$TAGGED_IMAGE"
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to tag image"
            }
            
            Write-Host "Pushing to GHCR..."
            docker push "$TAGGED_IMAGE"
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to push image"
            }
            
            Write-Host "Cleaning up local images..."
            docker rmi "$SOURCE_IMAGE" "$TAGGED_IMAGE" 2>$null
            
            Write-Host ""
            Write-Host "===================================="
            Write-Host "Success"
            Write-Host "Source: $SOURCE_IMAGE"
            Write-Host "Pushed: $TAGGED_IMAGE"
            Write-Host "===================================="
            
          } catch {
            Write-Host "Error:" $_.Exception.Message
            exit 1
          }